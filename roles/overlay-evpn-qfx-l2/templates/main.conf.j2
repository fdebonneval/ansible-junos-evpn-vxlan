/* This block of configuration has been generated by the role overlay-evpn-qfx-l2 for Ansible */

protocols {
    bgp {
        group OVERLAY_EVPN {
            type internal;
            family evpn {
                signaling;
            }
            local-address {{ loopback_ip }};
            local-as {{ overlay.local.asn }};
            multipath;
{% for neighbor in overlay.neighbors %}
            neighbor {{ neighbor }};
{% endfor %}
{% if overlay.remote_gw is defined %}
            import OVERLAY_IN;
{% endif %}
            bfd-liveness-detection {
                minimum-interval {{ overlay.bfd.min_interval }};
                multiplier {{ overlay.bfd.multiplier }};
                session-mode {{ overlay.bfd.mode }};
            }
        }
    }
    evpn {
        encapsulation vxlan;
        extended-vni-list [ {% for name, tenant in overlay.tenants.iteritems() %}{% for bd in tenant.bridge_domains %} {{ bd.vni_id }} {% endfor %}{% endfor %} ];
        multicast-mode ingress-replication;
        vni-options {
{% for name, tenant in overlay.tenants.iteritems() %}
{% for bd in tenant.bridge_domains %}
            vni {{ bd.vni_id }} {
                vrf-target export target:1:{{ bd.vni_id }};
            }
{% endfor %}
{% endfor %}
        }
    }
}

switch-options {
    vtep-source-interface lo0.0;
    vrf-import LEAF_IN;
    vrf-target target:9999:9999;
    route-distinguisher {{ loopback_ip }}:1;
}

policy-options {
     policy-statement LEAF_IN {
        term IMPORT_LEAF_ESI {
            from community COMM_LEAF_ESI;
            then accept;
          }
{% for name, tenant in overlay.tenants.iteritems() %}
{% for bd in tenant.bridge_domains %}
        term IMPORT_VNI_{{ bd.vni_id }} {
            from community COMM_{{ bd.vni_id }};
            then accept;
        }
{% endfor %}
{% endfor %}
        term DEFAULT {
            then reject;
        }
    }
{# Policy to reject Anycast GW from other pods #}
{% if overlay.remote_gw is defined %}
    policy-statement OVERLAY_IN {
      term REJECT_REMOTE_GW {
          from {
              family evpn;
              next-hop [ {% for gw in overlay.remote_gw %}{{ gw }} {% endfor %} ];
              nlri-route-type [ 1 2 ];
          }
          then reject;
      }
      term ACCEPT_ALL {
          then accept;
      }
    }
{% endif %}

{% for name, tenant in overlay.tenants.iteritems() %}
{% for bd in tenant.bridge_domains %}
    community COMM_{{ bd.vni_id }} members target:1:{{ bd.vni_id }};
{% endfor %}
{% endfor %}
    community COMM_LEAF_ESI members target:9999:9999;
}


vlans {
{% for name, tenant in overlay.tenants.iteritems() %}
{% for bd in tenant.bridge_domains %}
    BD{{ bd.vni_id }} {
{% if not overlay.vlan_normalized %}
        vlan-id {{ bd.vlan_id }};
{% endif %}
        vxlan {
            vni {{ bd.vni_id }};
            ingress-node-replication;
        }
    }
{% endfor %}
{% endfor %}
}
